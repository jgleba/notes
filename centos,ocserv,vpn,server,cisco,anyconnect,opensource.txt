==================================================================
CENTOS INSTALL OCSERV - CISCO ANYCONNECT - OPENSOURCE - VPN SERVER
05-17-19
JGleba
==================================================================

#https://ocserv.gitlab.io/www/recipes-ocserv-installation-CentOS-RHEL-Fedora.html
#https://www.vultr.com/docs/deploying-anyconnect-compatiable-vpn-server-with-certificate-verification-on-centos-7

#https://www.linuxbabe.com/ubuntu/openconnect-vpn-server-ocserv-ubuntu-16-04-17-10-lets-encrypt

==
INSTALL
==

sudo yum install epel-release -y
sudo yum install ocserv -y

==
CONFIGURE
==

sudo nano /etc/ocserv/ocserv.conf

WANT TO USE SEPARATE ACCOUNTS, NOT LINUX SYSTEM ACCOUNTS

comment
auth = "pam[gid-min=1000]"
auth = "pam"

uncomment or add
auth = "plain[passwd=/etc/ocserv/ocpasswd]"

ADD CERTS - NOT LISTED HERE

==
OTHER SETTINGS TO CHANGE IN CONFIG FILE
==

try-mtu-discovery = true
default-domain = vpn.jgleba.com
ipv4-network = 10.10.10.0
ipv4-netmask = 255.255.255.0
tunnel-all-dns = true
dns = 172.16.0.10

##WORKING, ADDS DEFAULT ROUTE TO CLIENT - 061119
#default = 10.10.10.1/255.255.255.0
##REGULAR ROUTE, NO GATEWAY
#route = 10.10.10.1/255.255.255.0
route = 172.16.3.3/255.255.255.0

==
FIREWALL - WRONG - SEE BELOW
==

sudo firewall-cmd --zone=public --add-port=443/tcp --permanent
sudo firewall-cmd --zone=public --add-port=443/udp --permanent
sudo firewall-cmd --reload

==
FIREWALL - NEED TO TRY NEXT TIME - 061219
==

sudo service firewalld start
sudo firewall-cmd --permanent --add-masquerade
sudo systemctl reload firewalld

==
ENABLE AND START
==

sudo systemctl enable ocserv
sudo systemctl start ocserv

==
CREATE ACCOUNTS
==

sudo ocpasswd -c /etc/ocserv/ocpasswd jgleba

==
ENABLE IP FORWARDING
==

sudo nano /etc/sysctl.conf

ADD

net.ipv4.ip_forward = 1

##TRYING THIS - 061019
##https://ocserv.gitlab.io/www/recipes-ocserv-firewall-iptables-ipv4.html

# Protect from IP Spoofing
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Ignore ICMP broadcast requests
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Protect from bad icmp error messages
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Disable source packet routing
net.ipv4.conf.all.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# Turn on exec shield
kernel.exec-shield = 1
kernel.randomize_va_space = 1

# Block SYN attacks
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_syn_retries = 5

# Log Martians
net.ipv4.conf.all.log_martians = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Ignore send redirects
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# Ignore ICMP redirects
net.ipv4.conf.all.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0

==
RELOAD SYSCTL
==

sudo sysctl -p

==
FIREWALL - MORE - NAT FOR CONNECTIVITY - WRONG - NOT WORKING
==

sudo iptables -t nat -A POSTROUTING -o vpns0 -j MASQUERADE
sudo iptables -t nat -L POSTROUTING

sudo firewall-cmd --zone=public --permanent --add-masquerade
sudo firewall-cmd --reload

==
CONNECTING TO VPN
==

CONNECTING FROM LINUX

sudo apt install openconnect
sudo openconnect -b vpn.example.com:port-number

CONNECTING FROM WINDOWS - USE CISCO ANYCONNECT CLIENT




==
TROUBLESHOOTING FIREWALL, EXTERNAL CONNECTIVITY, NATTING, HAPROXY
NOT WORKING PROPERLY THROUGH HAPROXY - 061019
SWITCHED FIREWALL TO IPTABLES, DISABLED FIREWALLD
==

##NOT WORKING, RULES SHOW UP IN OUTPUT CHAIN

sudo iptables -A INPUT -p tcp --dport 6556 -j ACCEPT
sudo iptables -A OUTPUT -p tcp --dport 6556 -j ACCEPT
sudo iptables -A INPUT -p udp --dport 6556 -j ACCEPT
sudo iptables -A OUTPUT -p udp --dport 6556 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 4443 -j ACCEPT

[user@zxvpn ~]$ sudo /usr/sbin/iptables-save
# Generated by iptables-save v1.4.21 on Mon Jun 10 15:27:37 2019
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [5:683]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A INPUT -p tcp -m tcp --dport 6556 -j ACCEPT
-A INPUT -p udp -m udp --dport 6556 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 4443 -j ACCEPT
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
-A OUTPUT -p tcp -m tcp --dport 6556 -j ACCEPT
-A OUTPUT -p udp -m udp --dport 6556 -j ACCEPT
COMMIT
# Completed on Mon Jun 10 15:27:37 2019

##TRYING THIS
##https://www.digitalocean.com/community/tutorials/how-to-set-up-a-basic-iptables-firewall-on-centos-6

sudo iptables -A INPUT -p tcp -m tcp --dport 4443 -j ACCEPT
sudo iptables -A INPUT -p udp -m udp --dport 4443 -j ACCEPT
sudo iptables -A INPUT -p tcp -m tcp --dport 6556 -j ACCEPT
sudo iptables -A OUTPUT -p tcp -m tcp --dport 6556 -j ACCEPT
sudo iptables -A INPUT -p udp -m udp --dport 6556 -j ACCEPT
sudo iptables -A OUTPUT -p udp -m udp --dport 6556 -j ACCEPT

sudo /usr/sbin/iptables-save

STILL NOT WORKING

https://www.centos.org/forums/viewtopic.php?t=69795

sudo service firewalld start
sudo firewall-cmd --permanent --add-masquerade
sudo systemctl reload firewalld

NO CHANGE, ON FR WORKSTATION, CONNECTS, THEN DISONNECTS, LOOP
CANT FIGURE OUT WHY

GOT SOMETHING
061119

TRIED THIS

sudo service firewalld start
sudo firewall-cmd --permanent --add-masquerade
sudo systemctl reload firewalld

NOW WORKING, BUT CORRECTED NETWORK AND ROUTES SECTION OF OCSERV CONFIG

==
CONNECT TO ACTIVE DIRECTORY
110719
==

##https://ocserv.gitlab.io/www/recipes-ocserv-ad-authentication.html

sudo yum install oddjob oddjob-mkhomedir sssd samba-common-tools realmd polkit.i686 iptables-services pam cracklib

sudo realm join --user=j dc1.domain.local

realm: Couldn't join realm: Necessary packages are not installed: oddjob, oddjob-mkhomedir, sssd, adcli

sudo yum install  sssd realmd oddjob oddjob-mkhomedir adcli openldap-clients policycoreutils-python

sudo realm join --user=user dc1.domain.local

sudo nano /etc/sssd/sssd.conf

change

use_fully_qualified_names = True
fallback_homedir = /home/%u@%d

to

use_fully_qualified_names = False
fallback_homedir = /home/%u

sudo systemctl restart sssd
sudo systemctl daemon-reload

sudo nano /etc/ocserv/ocserv.conf

auth = "pam"
#auth = "plain[passwd=/etc/ocserv/ocpasswd]"

sudo reboot

WORKING, BUT WORKS FOR ALL AD USERS, ALLLLLL AD USERS

==
LIMIT TO USERS IN OU, DOESNT WORK FOR GROUPS
==

##https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/windows_integration_guide/changing-the-ldap-search-base-for-users-and-groups-in-a-trusted-ad-domain

sudo nano /etc/sssd/sssd.conf

add 

ldap_search_base = ou=abcvpngroup,ou=jgroups,ou=jorg,dc=domain,dc=local
